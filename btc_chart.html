<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC Charts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000000;
            color: #e0e0e0;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            gap: 12px;
        }
        .export-btn {
            background: #1a1a1a;
            color: #ccc;
            border: 1px solid #444;
            padding: 8px 20px;
            font-size: 13px;
            font-family: 'Segoe UI', system-ui, sans-serif;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s;
        }
        .export-btn:hover {
            background: #2a2a2a;
            color: #fff;
            border-color: #666;
        }
        .wrapper {
            width: 1350px;
            height: 850px;
            display: flex;
            flex-direction: column;
        }
        .chart-panel {
            position: relative;
            border-bottom: 1px solid #333;
        }
        .chart-panel:last-child { border-bottom: none; }
        .chart-panel canvas {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>
<body>

<button class="export-btn" onclick="exportImage()">Export Image</button>
<div class="wrapper" id="chartWrapper">
    <div class="chart-panel" style="height: 510px;">
        <canvas id="btcChart"></canvas>
    </div>
    <div class="chart-panel" style="height: 340px;">
        <canvas id="exportDataChart"></canvas>
    </div>
</div>

<script>
const csvData = `time,low,zscore
1516748400,9720,
1517353200,5970,
1517958000,7235,
1518562800,8505,-0.8688968358243119
1519254000,9270,-0.4998036664066183
1519858800,9385,-0.1306212440324479
1520463600,8185,-1.209060334352866
1521064800,7700,-1.9728365018063254
1521669600,7745,-1.8868756138659013
1522274400,6725,-1.7803380920094145
1522879200,6485,-1.4757390741207905
1523484000,6660,-0.8244254492283742
1524088800,8100,0.06972521492968807
1524693600,8670,0.8592643562700181
1525298400,8955,0.9666953779012037
1525903200,8115,0.3031414780417919
1526508000,7445,-0.37199814685238136
1527112800,7050,-1.3826933281442135
1527804000,7300,-1.2147999111038315
1528408800,6100,-1.2428948823510773
1529013600,6340,-1.1544163954185191
1529618400,5960,-1.3569925481202587
1530223200,5755,-1.161282594651662
1531087200,6060,-1.0375702077214704
1531692000,6320,0.0581967171044515
1532296800,7335,1.8666553353423587
1532901600,7270,1.1201049115005142
1533506400,6105,-0.16595120984141692
1534111200,5850,-1.065276578404164
1534716000,6205,-0.9839536958947704
1535320800,6650,-0.24482507186293886
1535925600,6175,-0.13728291047038169
1536616800,6120,-0.6698728902243938
1537221600,6035,-1.396926358997992
1537826400,6315,-0.6671900667396129
1538431200,6345,-0.3326134637291371
1539036000,6030,-0.8611893392993464
1539640800,6330,-1.6977679113295614
1540245600,6185,-1.9299251539689524
1540850400,6170,-1.5548759760558704
1541458800,6240,-0.7523129752261031
1542063600,4560,-3.3632163508514834
1542668400,3515,-2.8432560062408005
1543359600,3690,-1.8390251269409774
1543964400,3135,-1.3847162176129937
1544569200,3120,-1.0784628924696569
1545174000,3550,-0.7080520315114374
1545865200,3525,-0.6452636351824921
1546383600,3685,-0.6456794005803014
1546988400,3400,-1.2296337724589164
1547593200,3390,-2.2882902077157934
1548284400,3300,-2.618848810168397
1548889200,3310,-2.31563944544454
1549494000,3325,-1.0771792998805825
1550098800,3530,0.31541142187699533
1550790000,3620,1.0491267024990494
1551394800,3655,0.8281192531735612
1551999600,3775,0.6119952207373754
1552600800,3845,0.8717912621040118
1553205600,3845,1.0670684837152522
1553810400,4000,3.2007728156571136
1554415200,4890,2.478651427747661
1555020000,4900,1.6440011304116242
1555624800,5255,1.355645987730164
1556229600,4930,0.9306258114449147
1556834400,5355,1.2055848829649196
1557439200,6110,2.6396656305137784
1558044000,6320,2.092549045771369
1558648800,7815,1.6461717609099689
1559512800,7435,1.0028585918218766
1560117600,7515,0.7816285460083903
1560722400,8985,1.4416676430298676
1561327200,10570,2.8052700493361598
1561932000,9805,1.909644008632362
1562623200,9915,1.3335479562027426
1563228000,9095,0.4848750574061878
1563832800,9195,-0.08240161773280119
1564437600,9470,-0.013011228033373094
1565042400,11325,1.3431424506306608
1565647200,9500,0.678887029063581
1566252000,9765,-0.16097991091609815
1566856800,9400,-1.0600794468581924
1567548000,9945,-0.4172297163078424
1568152800,9900,-0.36563877354697055
1568757600,7995,-0.8812191545703035
1569362400,7710,-2.4805578410594062
1569967200,7745,-1.9014612677525384
1570572000,8085,-1.1409054816575799
1571176800,7805,-0.91211006840627
1571781600,7280,-0.542935142173539
1572386400,8360,0.5009496161597807
1572994800,8555,0.7906817230624906
1573599600,8005,-0.31574776989623393
1574204400,6510,-1.8751316860392218
1574809200,6845,-1.7194722487223333
1575500400,7130,-1.2143315817791458
1576105200,6420,-1.0101264085604202
1576710000,7055,-0.8054402349008206
1577314800,7080,-0.7324076247362348
1577833200,6860,-0.532990842724966
1578438000,7700,1.4673532552856343
1579042800,8515,1.8150592943612807
1579734000,8235,1.3238166379792564
1580338800,9130,1.2626536835320168
1580943600,9510,1.3954583188369885
1581548400,9245,1.3229426754992273
1582239600,8575,0.6175099198238702
1582844400,8480,-0.3503905063664545
1583449200,5595,-1.6001077685618244
1584050400,4210,-2.033396985996775
1584655200,5665,-1.2034086287481403
1585260000,5835,-0.7424261655403298
1585864800,6625,-0.29991337958357994
1586469600,6465,-0.24239925240018564
1587074400,6765,-0.1804907986761744
1587679200,7465,1.1505753675811363
1588284000,8600,1.786009905420114
1588888800,8220,1.4609858264350426
1589493600,8815,1.1275169330365373
1590098400,8630,0.7314015211608338
1590962400,9335,0.8435039846500281
1591567200,9090,1.1864362706661005
1592172000,8930,1.5025291420862275
1592776800,9070,1.2668077680932661
1593381600,8950,-0.10077660003585372
1594072800,9145,-0.13202248720093834
1594677600,9040,-0.3479798404886255
1595282400,9175,1.377527487605963
1595887200,10635,3.1199416479798345
1596492000,11125,2.0270213883290364
1597096800,11190,1.337236103775492
1597701600,11580,0.932742491250975
1598306400,11115,0.611383648809227
1598911200,9890,0.12315223611809759
1599602400,9850,-1.0753987391801771
1600207200,10265,-0.8018858451959475
1600812000,10210,-0.39335400763522493
1601416800,10410,-0.34341273506694514
1602021600,10580,0.3338618866457851
1602626400,11225,2.09380524974814
1603231200,11960,2.370806994936289
1603836000,13035,1.84439913759437
1604444400,13635,1.7292906725776573
1605049200,15350,1.6427891926098832
1605654000,17235,1.6792112363481433
1606258800,16520,1.4852999162057194
1606950000,17705,1.2147782908958664
1607554800,17575,1.0472174206562272
1608159600,21320,1.9211985287642355
1608764400,22960,2.545022696350317
1609714800,28440,2.500935531142847
1610319600,31105,1.739275441199656
1610924400,28900,1.0414753284530052
1611615600,29075,0.6248309929764608
1612220400,33605,0.9970908546130541
1612825200,43950,2.473984749748265
1613516400,44900,2.4066865637980177
1614121200,44555,1.3535683960315452
1614726000,46295,0.9592130268996371
1615330800,53430,1.2373151052717881
1615932000,52915,1.5232767783676984
1616536800,50595,1.5508338497965861
1617141600,57155,1.7347750726872446
1617746400,55675,1.5832688697546438
1618351200,53430,1.589583871230054
1618956000,47395,0.12653183115202984
1619560800,52475,-0.4769396077544179
1620165600,52830,-0.01666834555258074
1620770400,42050,-1.5975087798760774
1621375200,30205,-2.153253194317455
1621980000,34250,-1.7199473635732003
1622671200,30915,-1.264529672335308
1623276000,35815,-0.7878212210234494
1623880800,28800,-0.8623056995555973
1624485600,31480,-1.1850868456016335
1625090400,32040,-1.9657022388978984
1625781600,30970,-2.3380592647081206
1626386400,29215,-2.1594525153885975
1626991200,31980,-0.021194810315770456
1627596000,37300,1.6057408887243587
1628200800,39910,1.8259135170082994
1628805600,43830,1.3225462329982691
1629410400,46310,1.132501561142832
1630015200,46350,0.959707573033593
1630620000,43705,0.810343818003046
1631484000,43310,0.7091340101209017
1632088800,40085,-0.22611130530697002
1632693600,40785,-0.8919276120753205
1633298400,47180,2.1325735177627885
1633903200,54370,2.6327747511684003
1634508000,60100,1.9374225610917466
1635112800,57855,1.1848526205074454
1635717600,59700,0.827116379687301
1636326000,62385,0.9422640326190185
1636930800,55600,0.6510896486911601
1637535600,53600,-0.541393587089989
1638226800,47215,-1.3149264510711414
1638831600,45700,-1.5735692780288928
1639436400,45415,-1.3186458355106234
1640041200,46710,-0.8465766781270163
1640732400,45695,-0.849769486750091
1641164400,40470,-1.1743434761978158
1641769200,39470,-1.5414756939315772
1642374000,32855,-1.9392243408846523
1643065200,35455,-1.9170149765395936
1643670000,36235,-1.2620415093985304
1644274800,41560,-0.2874286253809921
1644879600,36340,-0.13253876857820263
1645570800,34300,-0.7810445144919782
1646175600,37180,-0.9337920058496736
1646780400,37495,-1.0204756056302458
1647381600,38810,-0.5637099275097889
1647986400,41815,2.2573838237991812
1648591200,44345,1.9610737032219583
1649196000,39190,0.4696281521337181
1649800800,38535,-0.5649914417812179
1650492000,37665,-1.0684854725900501
1651096800,37420,-1.103897947768284
1651701600,28105,-1.6618351680038488
1652306400,25350,-1.717969976840849
1652911200,28555,-1.4390657684829045
1653516000,27890,-0.9800698609772789
1654207200,29130,-0.700349713988929
1654812000,20025,-1.5913091451940666
1655416800,19600,-2.44391130759689
1656280800,18525,-1.9144824435243408
1656885600,18985,-1.1630159442236603
1657576800,18830,-0.8406070475265219
1658181600,21575,-0.41258007536801367
1658786400,20715,-0.16046951349779276
1659391200,22405,0.09626315638606557
1659996000,22630,0.4433265954228646
1660600800,20805,-0.020929807325821746
1661205600,19345,-1.4531175151229532
1661810400,18480,-2.232413357809659
1662501600,18360,-1.140306939077604
1663106400,18195,-0.9011393461178316
1663711200,18085,-0.9355167234378449
1664316000,18440,-0.9413732785809208
1664920800,18760,-1.0796904995819812
1665525600,17810,-1.864760621232771
1666130400,18615,-1.675810035256016
1666735200,19960,1.416733893989446
1667340000,16835,1.2043924119627125
1667948400,14925,-3.0816793005624037
1668553200,15355,-2.261152470176138
1669158000,15540,-1.3563417402429623
1669849200,16055,-0.697513029660624
1670454000,16665,-0.28115243535519596
1671058800,16275,-0.35835184900210465
1671663600,16220,-1.2125327125363956
1672354800,16090,-1.5044521157072217
1672700400,16525,-1.2482265041480756
1673305200,17135,2.654051584815002
1673996400,20460,2.724747847166451
1674601200,22345,1.8464948234824792
1675206000,22725,1.2550374930640176
1675810800,21380,0.6786883000531629
1676415600,22100,0.8511444732667719
1677106800,22965,1.021362787041475
1677711600,21880,0.8699509826287732
1678316400,19520,0.632556202112444
1678917600,24250,3.568333408593128
1679522400,26520,2.39824173069799
1680127200,27595,1.5982913044632059
1680732000,27765,1.212268224873496
1681336800,29010,1.084252067738759
1681941600,26980,0.6123814317269662
1682546400,27710,0.6977436054546057
1683151200,26745,0.6628441462843677
1683756000,25840,-0.7526074961442596
1684360800,26015,-1.0143919689792265
1684965600,25985,-0.6979073523868989
1685656800,25315,-0.7247738629894493
1686261600,24745,-1.1614540146961192
1686866400,25145,1.2874309896504958
1687730400,29605,2.4032538768332388
1688335200,29875,1.555414899815418
1689026400,29740,0.9525938169980366
1689631200,28810,0.42164792236203613
1690236000,29055,0.042032038514049824
1690840800,28625,-0.25366704414482844
1691445600,29095,-0.08000323138593575
1692050400,25600,-1.3754100538749159
1692655200,25585,-2.038965097585643
1693260000,25400,-1.545929608415655
1693951200,24925,-1.2230960319703506
1694556000,25845,-0.6999354056721443
1695160800,25985,-0.4472534972156857
1695765600,26080,0.039549044725362754
1696370400,27270,1.0307301120036971
1696975200,26575,0.817164735263846
1697580000,28175,2.185711268753963
1698184800,33655,2.3922994467148544
1698789600,34310,1.739805006156302
1699398000,34820,1.3437926159892477
1700002800,35490,1.062730140774025
1700607600,36185,1.0667721670929609
1701298800,37870,1.7819994179352854
1701903600,40450,1.9688959516365603
1702508400,40705,1.5469831050935878
1703113200,41645,1.1908309230944218
1703804400,41930,1.1232317809908934
1704150000,41110,1.264225324652187
1704754800,41705,1.5630616613728048
1705446000,38540,0.3257772515548941
1706050800,39450,-0.6426756163233008
1706655600,42100,0.05009963876591992
1707260400,42930,2.2121260325568612
1707865200,49535,2.410108693773341
1708556400,51225,1.9661590568053298
1709161200,60120,1.8527254266876385
1709766000,66060,1.712692649952586
1710367200,61020,1.1714483415407986
1710972000,62655,0.8809919943576584
1711576800,64910,0.7720842033608153
1712268000,66300,1.0999377640618357
1712872800,59705,0.4774341321080027
1713477600,59635,-0.2968998211909338
1714082400,56910,-1.366783594945837
1714687200,59265,-0.808413372492763
1715292000,60425,-0.3380097822493102
1715896800,65345,1.1081049878922293
1716501600,66730,1.5301034059664953
1717365600,68070,1.3028820528538034
1717970400,65200,0.5594961396961768
1718575200,58410,-0.4187138501277303
1719266400,59890,-1.5997818219559035
1719871200,53635,-1.6030365919123812
1720562400,56685,-0.9333122184944184
1721167200,63340,0.10707305678712897
1721772000,64080,0.9317745083248107
1722376800,49365,-0.1958065061985352
1722981600,54790,-1.2401454866969681
1723586400,56295,-1.2048784638948258
1724191200,58900,-0.2651077951923626
1724796000,55725,-0.4630764995266635
1725487200,52820,-1.0903975926193676
1726092000,57415,-1.2816799875167748
1726696800,60345,1.3631997834117051
1727301600,60265,1.4830938057533256
1727906400,60070,0.7422860502484199
1728511200,58945,0.8810726417632768
1729116000,65210,1.4359349420832948
1729720800,66375,1.963253295259471
1730325600,67140,1.6340122202014937
1730934000,75070,2.3847054961521743
1731538800,87005,2.062773133493848
1732143600,91720,1.622351818348902
1732748400,94435,1.254049722092241
1733439600,94640,1.0445238205758733
1734044400,95765,1.0975724732752723
1734649200,92355,0.8865790022522918
1735513200,91735,0.7504465566742485
1735772400,92745,0.9776044901370697
1736377200,89525,0.4862470115921677
1736982000,97555,2.504701238287769
1737673200,97650,2.3811660377321426
1738278000,91455,0.9823368443588846
1738882800,94285,-0.3906936640331172
1739487600,93305,-0.8261088411501643
1740351600,78675,-1.9264988108699181
1740956400,81815,-1.3533248076321038
1741557600,76735,-1.3404109125089285
1742162400,81120,-1.058654492202546
1742767200,83800,-0.6253420113581283
1743372000,81400,-0.7212376924854816
1743976800,74635,-2.0495132274198604
1744581600,83190,-1.5711018438255038
1745272800,87070,2.295365192033704
1745877600,93445,1.886573153744274
1746482400,93685,1.5202682715314015
1747087200,101705,1.3084663907557885
1747692000,104435,1.3288130995850618
1748383200,104100,1.0601668826268036
1748988000,100815,0.9078715212704922
1749592800,103010,0.9299782492113332
1750197600,99090,0.7981980610650797
1750888800,105440,2.1361065463011686
1751493600,107680,4.823132733396319
1752184800,115635,2.995127839239229
1752789600,116275,1.9109324979976368
1753394400,115675,1.1828065881551821
1753999200,113045,0.5912928464308436
1754604000,116295,0.8846690022234135
1755208800,112075,0.569560652348852
1755813600,108845,-1.130558577189465
1756418400,107790,-1.3697734454211041
1757282400,111000,-0.5424480076913258
1757887200,114635,0.47726411737613145
1758492000,109225,-0.2247759608909948
1759096800,111355,1.1726469881467811
1759701600,113150,1.9869498739970317
1760306400,103745,-0.057401563603568025
1760911200,106950,-1.5779350078450567
1761516000,106735,-1.2306569606854274
1762124400,99250,-1.5133451204585915
1762729200,94230,-1.467123743539528
1763334000,80750,-1.8557276277687647
1763938800,84120,-1.6074101967213892
1764630000,86500,-1.0649891880909297
1765234800,85325,-0.7631667689638638
1765839600,84505,-1.0298518636169267
1766444400,86760,-1.449262539104575
1767135600,87470,-1.5967148757558143
1767308400,88720,-1.2031068711052628
1767913200,89825,0.9015826220351025
1768518000,87270,0.23634846794923425
1769382000,81210,-1.2265859219624324
1769986800,60005,-3.1223663685088474
1770591600,68000,-2.6326172132354886`;

// Parse CSV
const lines = csvData.trim().split('\n');
const data = lines.slice(1).map(line => {
    const parts = line.split(',');
    return {
        time: new Date(parseInt(parts[0]) * 1000),
        low: parseFloat(parts[1]),
        zscore: parts[2] ? parseFloat(parts[2]) : null
    };
});

// Filter from March 2018
const march2018 = new Date(2018, 2, 1);
const filteredData = data.filter(d => d.time >= march2018);
const zscoreData = filteredData.filter(d => d.zscore !== null);

const timeMin = filteredData[0].time;
// Add 60 days padding so the last price isn't glued to the right edge
const rawTimeMax = filteredData[filteredData.length - 1].time;
const timeMax = new Date(rawTimeMax.getTime() + 60 * 24 * 60 * 60 * 1000);

// Colors for dark mode
const gridColor = 'rgba(255,255,255,0.08)';
const borderColor = '#444';
const tickColor = '#999';
const tooltipBg = '#1a1a1a';
const tooltipBorder = '#444';
const tooltipText = '#eee';

// Build z-score lookup by timestamp for BTC green background
const zscoreLookup = {};
zscoreData.forEach(d => { zscoreLookup[d.time.getTime()] = d.zscore; });

// Interpolate zscore for each filteredData point
function getZscoreForTime(t) {
    const ts = t.getTime();
    if (zscoreLookup[ts] !== undefined) return zscoreLookup[ts];
    // Find nearest zscore point
    let closest = null, minDist = Infinity;
    for (const d of zscoreData) {
        const dist = Math.abs(d.time.getTime() - ts);
        if (dist < minDist) { minDist = dist; closest = d; }
    }
    return closest ? closest.zscore : null;
}

// ============ CHART 1: BTC Low (orange line, LOG scale, green bg when z < -2.8) ============
const ctx1 = document.getElementById('btcChart').getContext('2d');

// Orange gradient for area fill
const gradientBtc = ctx1.createLinearGradient(0, 0, 0, 510);
gradientBtc.addColorStop(0, 'rgba(245, 124, 0, 0.45)');
gradientBtc.addColorStop(0.5, 'rgba(245, 124, 0, 0.15)');
gradientBtc.addColorStop(1, 'rgba(245, 124, 0, 0)');

// Plugin to paint green background on BTC chart where z-score < -2.8
const greenBgPlugin = {
    id: 'greenBgPlugin',
    beforeDraw(chart) {
        const { ctx, chartArea, scales } = chart;
        if (!chartArea) return;
        const xScale = scales.x;
        const labels = chart.data.labels;
        
        ctx.save();
        ctx.beginPath();
        ctx.rect(chartArea.left, chartArea.top, chartArea.width, chartArea.height);
        ctx.clip();
        
        for (let i = 0; i < labels.length - 1; i++) {
            const t = labels[i];
            const z = getZscoreForTime(t);
            if (z !== null && z < -2.8) {
                const x1 = xScale.getPixelForValue(labels[i]);
                const x2 = xScale.getPixelForValue(labels[i + 1]);
                ctx.fillStyle = 'rgba(0, 180, 70, 0.35)';
                ctx.fillRect(x1, chartArea.top, x2 - x1, chartArea.height);
            }
        }
        ctx.restore();
    }
};

// Watermark image for BTC chart
const watermarkImg = new Image();
watermarkImg.src = 'wm.png';
watermarkImg.onload = () => { chart1.draw(); };
const watermarkPlugin = {
    id: 'watermarkPlugin',
    beforeDraw(chart) {
        const { ctx, chartArea } = chart;
        if (!chartArea || !watermarkImg.complete || !watermarkImg.naturalWidth) return;
        ctx.save();
        ctx.globalAlpha = 0.055;
        const imgH = chartArea.height * 0.85;
        const imgW = imgH * (watermarkImg.naturalWidth / watermarkImg.naturalHeight);
        const x = chartArea.left + 25;
        const y = chartArea.top + (chartArea.height - imgH) / 2;
        ctx.drawImage(watermarkImg, x, y, imgW, imgH);
        ctx.restore();
    }
};

// Green dots data for BTC (where z < -2.8)
const btcGreenDots = filteredData.map(d => {
    const z = getZscoreForTime(d.time);
    return (z !== null && z < -2.8) ? d.low : null;
});
const btcGreenRadius = filteredData.map(d => {
    const z = getZscoreForTime(d.time);
    return (z !== null && z < -2.8) ? 5 : 0;
});

const chart1 = new Chart(ctx1, {
    type: 'line',
    data: {
        labels: filteredData.map(d => d.time),
        datasets: [{
            label: 'BTC Low',
            data: filteredData.map(d => d.low),
            borderColor: '#f57c00',
            backgroundColor: gradientBtc,
            borderWidth: 1.4,
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 3,
            pointHoverBackgroundColor: '#f57c00',
            tension: 0.1
        },
        {
            label: 'Buy Zone',
            data: btcGreenDots,
            borderColor: 'transparent',
            backgroundColor: 'rgba(0, 200, 80, 0.9)',
            borderWidth: 0,
            fill: false,
            pointRadius: btcGreenRadius,
            pointBackgroundColor: 'rgba(0, 200, 80, 0.9)',
            pointBorderColor: 'rgba(0, 200, 80, 0.9)',
            tension: 0.1,
            showLine: false
        }]
    },
    plugins: [greenBgPlugin, watermarkPlugin, {
        id: 'btcLegend',
        afterDraw(chart) {
            const { ctx, chartArea } = chart;
            if (!chartArea) return;
            const x = chartArea.left + 12;
            const y = chartArea.top + 16;
            ctx.save();
            ctx.beginPath();
            ctx.arc(x, y, 5, 0, Math.PI * 2);
            ctx.fillStyle = '#f57c00';
            ctx.fill();
            ctx.font = '12px Segoe UI, system-ui, sans-serif';
            ctx.fillStyle = '#ccc';
            ctx.textBaseline = 'middle';
            ctx.fillText('BTCUSD', x + 10, y);
            ctx.restore();
        }
    }],
    options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { top: 20, right: 40, left: 4, bottom: 15 } },
        interaction: { intersect: false, mode: 'index' },
        plugins: {
            title: { display: false },
            legend: { display: false },
            tooltip: {
                backgroundColor: tooltipBg,
                borderColor: tooltipBorder,
                borderWidth: 1,
                titleColor: tooltipText,
                bodyColor: tooltipText,
                titleFont: { size: 11, weight: '600' },
                bodyFont: { size: 11 },
                padding: 8,
                displayColors: false,
                callbacks: {
                    label: function(c) { return '$' + c.parsed.y.toLocaleString(); }
                }
            }
        },
        scales: {
            x: {
                type: 'time',
                min: timeMin,
                max: timeMax,
                time: { unit: 'year', displayFormats: { year: 'yyyy-MM' } },
                grid: { display: false },
                ticks: { display: false },
                border: { color: borderColor }
            },
            y: {
                type: 'logarithmic',
                position: 'right',
                grid: { display: false },
                ticks: {
                    color: tickColor,
                    font: { size: 11, family: 'Segoe UI' },
                    padding: 6,
                    callback: function(v) {
                        if ([3000,5000,10000,20000,30000,50000,100000].includes(v)) {
                            return '$' + v.toLocaleString();
                        }
                        return '';
                    }
                },
                border: { color: borderColor },
                afterFit(axis) { axis.width = 75; }
            }
        }
    }
});

// ============ CHART 2: Z-Score Plot (red line) ============
const ctx2 = document.getElementById('exportDataChart').getContext('2d');

// Plugin: green dashed line at -2.8
const dashedLinePlugin = {
    id: 'dashedLinePlugin',
    afterDraw(chart) {
        const { ctx, chartArea, scales } = chart;
        if (!chartArea) return;
        const yScale = scales.y;
        const yPixel = yScale.getPixelForValue(-2.8);
        if (yPixel < chartArea.top || yPixel > chartArea.bottom) return;
        
        ctx.save();
        ctx.beginPath();
        ctx.setLineDash([6, 4]);
        ctx.strokeStyle = 'rgba(0, 200, 80, 0.8)';
        ctx.lineWidth = 1.2;
        ctx.moveTo(chartArea.left, yPixel);
        ctx.lineTo(chartArea.right, yPixel);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.restore();
    }
};

// Green bg plugin for Z-Score chart
const greenBgPluginZ = {
    id: 'greenBgPluginZ',
    beforeDraw(chart) {
        const { ctx, chartArea, scales } = chart;
        if (!chartArea) return;
        const xScale = scales.x;
        const labels = chart.data.labels;
        
        ctx.save();
        ctx.beginPath();
        ctx.rect(chartArea.left, chartArea.top, chartArea.width, chartArea.height);
        ctx.clip();
        
        for (let i = 0; i < labels.length - 1; i++) {
            const z = zscoreData[i] ? zscoreData[i].zscore : null;
            if (z !== null && z < -2.8) {
                const x1 = xScale.getPixelForValue(labels[i]);
                const x2 = xScale.getPixelForValue(labels[i + 1]);
                ctx.fillStyle = 'rgba(0, 180, 70, 0.35)';
                ctx.fillRect(x1, chartArea.top, x2 - x1, chartArea.height);
            }
        }
        ctx.restore();
    }
};

// Green dots for Z-Score (where z < -2.8)
const zscoreGreenDots = zscoreData.map(d => (d.zscore !== null && d.zscore < -2.8) ? d.zscore : null);
const zscoreGreenRadius = zscoreData.map(d => (d.zscore !== null && d.zscore < -2.8) ? 5 : 0);

const chart2 = new Chart(ctx2, {
    type: 'line',
    data: {
        labels: zscoreData.map(d => d.time),
        datasets: [
        {
            label: 'Z-Score Fill',
            data: zscoreData.map(d => d.zscore),
            borderColor: 'transparent',
            backgroundColor: 'transparent',
            borderWidth: 0,
            fill: { target: { value: -2.8 }, above: 'transparent', below: 'rgba(0, 200, 80, 0.5)' },
            pointRadius: 0,
            tension: 0.1
        },
        {
            label: 'Z-Score Plot',
            data: zscoreData.map(d => d.zscore),
            borderColor: '#ff4444',
            backgroundColor: 'transparent',
            borderWidth: 1.4,
            fill: false,
            pointRadius: 0,
            pointHoverRadius: 3,
            pointHoverBackgroundColor: '#ff4444',
            tension: 0.1
        },
        {
            label: 'Buy Zone Z',
            data: zscoreGreenDots,
            borderColor: 'transparent',
            backgroundColor: 'rgba(0, 200, 80, 0.9)',
            borderWidth: 0,
            fill: false,
            pointRadius: zscoreGreenRadius,
            pointBackgroundColor: 'rgba(0, 200, 80, 0.9)',
            pointBorderColor: 'rgba(0, 200, 80, 0.9)',
            tension: 0.1,
            showLine: false
        }]
    },
    plugins: [dashedLinePlugin, greenBgPluginZ, {
        id: 'zscoreLegend',
        afterDraw(chart) {
            const { ctx, chartArea } = chart;
            if (!chartArea) return;
            const x = chartArea.left + 12;
            const y = chartArea.top + 16;
            ctx.save();
            ctx.beginPath();
            ctx.arc(x, y, 5, 0, Math.PI * 2);
            ctx.fillStyle = '#ff4444';
            ctx.fill();
            ctx.font = '12px Segoe UI, system-ui, sans-serif';
            ctx.fillStyle = '#ccc';
            ctx.textBaseline = 'middle';
            ctx.fillText('Indicador', x + 10, y);
            ctx.restore();
        }
    }],
    options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { top: 6, right: 40, left: 4, bottom: 4 } },
        interaction: { intersect: false, mode: 'index' },
        plugins: {
            title: { display: false },
            legend: { display: false },
            tooltip: {
                backgroundColor: tooltipBg,
                borderColor: tooltipBorder,
                borderWidth: 1,
                titleColor: tooltipText,
                bodyColor: tooltipText,
                titleFont: { size: 11, weight: '600' },
                bodyFont: { size: 11 },
                padding: 8,
                displayColors: false,
                callbacks: {
                    label: function(c) { return c.parsed.y.toFixed(3); }
                }
            }
        },
        scales: {
            x: {
                type: 'time',
                min: timeMin,
                max: timeMax,
                time: { unit: 'year', displayFormats: { year: 'yyyy-MM' } },
                grid: { display: false },
                ticks: {
                    color: tickColor,
                    font: { size: 11, family: 'Segoe UI' },
                    padding: 6,
                    maxRotation: 0
                },
                border: { color: borderColor }
            },
            y: {
                position: 'right',
                grid: { display: false },
                ticks: {
                    color: tickColor,
                    font: { size: 11, family: 'Segoe UI' },
                    padding: 6,
                    callback: function(v) { return v.toFixed(1); }
                },
                border: { color: borderColor },
                afterFit(axis) { axis.width = 75; }
            }
        }
    }
});

// ============ EXPORT IMAGE ============
function exportImage() {
    const wrapper = document.getElementById('chartWrapper');
    const w = wrapper.offsetWidth;
    const h = wrapper.offsetHeight;
    const scale = 2;

    const exportCanvas = document.createElement('canvas');
    exportCanvas.width = w * scale;
    exportCanvas.height = h * scale;
    const ectx = exportCanvas.getContext('2d');
    ectx.scale(scale, scale);

    // Black background
    ectx.fillStyle = '#000000';
    ectx.fillRect(0, 0, w, h);

    // Draw each chart canvas
    const panels = wrapper.querySelectorAll('.chart-panel');
    let yOffset = 0;
    panels.forEach(panel => {
        const canvas = panel.querySelector('canvas');
        const panelH = panel.offsetHeight;
        ectx.drawImage(canvas, 0, yOffset, w, panelH);
        yOffset += panelH;
    });

    // Separator line
    const firstPanelH = panels[0].offsetHeight;
    ectx.strokeStyle = '#333';
    ectx.lineWidth = 1;
    ectx.beginPath();
    ectx.moveTo(0, firstPanelH);
    ectx.lineTo(w, firstPanelH);
    ectx.stroke();

    // Trigger download
    const link = document.createElement('a');
    link.download = 'BTC_ZScore_Chart.png';
    link.href = exportCanvas.toDataURL('image/png');
    link.click();
}
</script>

</body>
</html>
